name: Sync Running Activities

on:
  # 每天 UTC 0:00 自动执行（北京时间上午 8:00）
  schedule:
    - cron: '0 0 * * *'

  # 允许手动触发
  workflow_dispatch:
    inputs:
      sync_source:
        description: 'Sync source (strava or nike)'
        required: false
        default: 'strava'
        type: choice
        options:
          - strava
          - nike

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Initialize database
        run: bun run db:push

      - name: Sync activities
        env:
          # Strava credentials (优先)
          STRAVA_CLIENT_ID: ${{ secrets.STRAVA_CLIENT_ID }}
          STRAVA_CLIENT_SECRET: ${{ secrets.STRAVA_CLIENT_SECRET }}
          STRAVA_REFRESH_TOKEN: ${{ secrets.STRAVA_REFRESH_TOKEN }}

          # Nike credentials (备选)
          NIKE_REFRESH_TOKEN: ${{ secrets.NIKE_REFRESH_TOKEN }}
          NIKE_ACCESS_TOKEN: ${{ secrets.NIKE_ACCESS_TOKEN }}

          # Sync source override
          SYNC_SOURCE: ${{ github.event.inputs.sync_source || 'auto' }}
        run: bun run sync

      - name: Commit database changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/activities.db
          git diff --quiet --staged || git commit -m "sync: update activities [skip ci]"
          git push
